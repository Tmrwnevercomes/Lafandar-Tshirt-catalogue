<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T-Shirt Inventory Management (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .main-content {
            transition: margin-left 0.3s ease-in-out;
        }
        /* Simple loading spinner */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Loading Spinner -->
    <div id="loader">
        <div class="spinner"></div>
    </div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 sidebar">
            <a href="#" class="text-white flex items-center space-x-2 px-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.993.883L4 8v9a1 1 0 001 1h10a1 1 0 001-1V8l-.007-.117A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4z" clip-rule="evenodd" />
                </svg>
                <span class="text-2xl font-extrabold">T-Shirt Stock</span>
            </a>
            <nav>
                <a href="#dashboard" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white">Dashboard</a>
                <a href="#inventory" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white">Inventory</a>
                <a href="#sales" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white">Sales</a>
                <a href="#reports" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white">Reports</a>
                <a href="#settings" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white">Settings</a>
            </nav>
             <div class="px-4 py-2 mt-auto">
                <p class="text-xs text-gray-400">User ID:</p>
                <p id="user-id" class="text-xs text-gray-300 break-all"></p>
            </div>
        </aside>

        <!-- Main content -->
        <div class="flex-1 flex flex-col overflow-hidden main-content">
            <header class="flex justify-between items-center p-4 bg-white border-b-2 border-gray-200">
                <div class="flex items-center">
                    <button id="menu-button" class="text-gray-500 focus:outline-none md:hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    <h1 id="page-title" class="text-2xl font-semibold text-gray-800 ml-2">Dashboard</h1>
                </div>
            </header>
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-200 p-4 md:p-6">
                <!-- Page Content -->
                <div id="app-content"></div>
            </main>
        </div>
    </div>

    <!-- Modal Structure -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div id="modal-content" class="relative top-20 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white">
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, writeBatch, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE SETUP ---
        // IMPORTANT: PASTE YOUR FIREBASE CONFIGURATION HERE
       const firebaseConfig = {
  apiKey: "AIzaSyB1suQ3V4LFaIfVbLPKkNpBxPp9zArQeRA",
  authDomain: "t-shirt-inventory.firebaseapp.com",
  projectId: "t-shirt-inventory",
  storageBucket: "t-shirt-inventory.firebasestorage.app",
  messagingSenderId: "595119793113",
  appId: "1:595119793113:web:386f8e56417a05f4a96fc8"
};

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null; // To store the current user's ID
        let dbRefs = {}; // To store references to user's collections

        // --- DATA MANAGEMENT (FIRESTORE) ---
        const DB = {
            // Local cache of data, kept in sync with Firestore
            products: [],
            variants: [],
            transactions: [],
            settings: {
                sizes: ['S', 'M', 'L', 'XL', 'XXL'],
                colors: ['Red', 'Blue', 'Black', 'White', 'Green'],
                materials: ['Cotton', 'Polyester', 'Blend']
            },
            isDataLoaded: false,

            // Initialize listeners to sync local cache with Firestore in real-time
            initRealtimeListeners() {
                const collections = ['products', 'variants', 'transactions'];
                collections.forEach(colName => {
                    onSnapshot(dbRefs[colName], (snapshot) => {
                        this[colName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log(`Updated ${colName}:`, this[colName]);
                        this.checkDataLoaded();
                    });
                });
                
                // Listener for settings
                 onSnapshot(dbRefs.settingsDoc, (doc) => {
                    if (doc.exists()) {
                        this.settings = doc.data();
                    }
                    console.log('Updated settings:', this.settings);
                    this.checkDataLoaded();
                });
            },

            // Check if all initial data has been loaded
            checkDataLoaded() {
                // This is a simple check. A more robust solution might use Promises.
                if (!this.isDataLoaded) {
                    this.isDataLoaded = true;
                    document.getElementById('loader').style.display = 'none';
                    App.init(); // Start the app router once data is loaded
                } else {
                    // If data is already loaded, just re-render the current page
                    App.renderPage(App.currentPage);
                }
            },
            
            // Get product by ID from local cache
            getProduct(id) {
                return this.products.find(p => p.id === id);
            },

            // Get variant by ID from local cache
            getVariant(id) {
                return this.variants.find(v => v.id === id);
            },
            
            // Get all variants for a product from local cache
            getProductVariants(productId) {
                return this.variants.filter(v => v.productId === productId);
            },
            
            // Calculate current stock for a specific variant instance
            getVariantStock(variantId) {
                return this.transactions
                    .filter(t => t.variantId === variantId)
                    .reduce((total, t) => total + t.quantity, 0);
            },
            
            // Add a new product to Firestore
            async addProduct(product) {
                await addDoc(dbRefs.products, product);
            },

            // Update a product in Firestore
            async updateProduct(updatedProduct) {
                const docRef = doc(db, dbRefs.products.path, updatedProduct.id);
                // We remove the ID from the object because we don't want to store it inside the document itself
                const dataToUpdate = { ...updatedProduct };
                delete dataToUpdate.id;
                await setDoc(docRef, dataToUpdate);
            },
            
            // Delete a product and its associated variants and transactions
            async deleteProduct(productId) {
                const batch = writeBatch(db);

                // 1. Delete the product document
                const productRef = doc(db, dbRefs.products.path, productId);
                batch.delete(productRef);

                // 2. Find and delete associated variants
                const variantsToDelete = this.getProductVariants(productId);
                const variantIdsToDelete = variantsToDelete.map(v => v.id);
                variantIdsToDelete.forEach(variantId => {
                    const variantRef = doc(db, dbRefs.variants.path, variantId);
                    batch.delete(variantRef);
                });

                // 3. Find and delete associated transactions
                const q = query(dbRefs.transactions, where("variantId", "in", variantIdsToDelete));
                const querySnapshot = await getDocs(q); // Note: getDocs is not real-time
                querySnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
            },

            // Add a new variant to Firestore
            async addVariant(variant) {
                // Add initial stock as a transaction if necessary
                const initialStock = variant.initialStock || 0;
                delete variant.initialStock;

                const newVariantRef = await addDoc(dbRefs.variants, variant);
                
                if (initialStock > 0) {
                    await this.addTransaction({
                        variantId: newVariantRef.id,
                        type: 'Purchase',
                        quantity: parseInt(initialStock, 10),
                        salesChannel: 'N/A',
                        notes: 'Initial stock'
                    });
                }
            },

            // Update a variant in Firestore
            async updateVariant(updatedVariant) {
                const docRef = doc(db, dbRefs.variants.path, updatedVariant.id);
                const dataToUpdate = { ...updatedVariant };
                delete dataToUpdate.id;
                await setDoc(docRef, dataToUpdate);
            },

            // Delete a variant and its transactions
            async deleteVariant(variantId) {
                const batch = writeBatch(db);

                // 1. Delete variant
                const variantRef = doc(db, dbRefs.variants.path, variantId);
                batch.delete(variantRef);

                // 2. Delete transactions
                const q = query(dbRefs.transactions, where("variantId", "==", variantId));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
            },

            // Add a transaction to Firestore
            async addTransaction(transaction) {
                transaction.date = new Date().toISOString();
                await addDoc(dbRefs.transactions, transaction);
            },

            // Save settings to Firestore
            async saveSettings(newSettings) {
                await setDoc(dbRefs.settingsDoc, newSettings);
            }
        };

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in.
                console.log("User signed in with UID:", user.uid);
                userId = user.uid;
                document.getElementById('user-id').textContent = userId;

                // Set up collection references for the current user
                // This ensures each user has their own separate data
                dbRefs.products = collection(db, 'users', userId, 'products');
                dbRefs.variants = collection(db, 'users', userId, 'variants');
                dbRefs.transactions = collection(db, 'users', userId, 'transactions');
                dbRefs.settingsDoc = doc(db, 'users', userId, 'settings', 'userSettings');

                // Start listening for real-time data updates
                DB.initRealtimeListeners();

            } else {
                // User is signed out. Sign in anonymously.
                console.log("No user found, signing in anonymously...");
                signInAnonymously(auth).catch((error) => {
                    console.error("Anonymous sign-in failed:", error);
                    alert("Could not connect to the database. Please check your connection and Firebase setup.");
                });
            }
        });

        // --- UI ROUTING AND RENDERING (largely unchanged) ---
        // NOTE: All DB write operations (add, update, delete) are now async.
        // The UI will update automatically thanks to the onSnapshot listeners.
        const App = {
            currentPage: 'dashboard',
            chartInstance: null,
            isInitialized: false,

            init() {
                if(this.isInitialized) return;
                this.isInitialized = true;
                
                this.router();
                window.addEventListener('hashchange', this.router.bind(this));
                document.querySelector('#menu-button').addEventListener('click', () => {
                    document.querySelector('#sidebar').classList.toggle('-translate-x-full');
                });
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', () => {
                        if (window.innerWidth < 768) {
                           document.querySelector('#sidebar').classList.add('-translate-x-full');
                        }
                    });
                });
            },

            router() {
                const route = window.location.hash.replace('#', '') || 'dashboard';
                this.currentPage = route;
                this.renderPage(route);
            },

            renderPage(page) {
                const content = document.querySelector('#app-content');
                const pageTitle = document.querySelector('#page-title');
                pageTitle.textContent = page.charAt(0).toUpperCase() + page.slice(1);
                
                content.innerHTML = '';
                if (this.chartInstance) {
                    this.chartInstance.destroy();
                    this.chartInstance = null;
                }

                switch (page) {
                    case 'dashboard':
                        content.innerHTML = this.getDashboardHTML();
                        this.renderDashboardChart();
                        break;
                    case 'inventory':
                        content.innerHTML = this.getInventoryHTML();
                        this.attachInventoryListeners();
                        break;
                    case 'sales':
                        content.innerHTML = this.getSalesHTML();
                        this.attachSalesListeners();
                        break;
                    case 'reports':
                        content.innerHTML = this.getReportsHTML();
                        this.attachReportsListeners();
                        break;
                    case 'settings':
                        content.innerHTML = this.getSettingsHTML();
                        this.attachSettingsListeners();
                        break;
                    default:
                        content.innerHTML = `<p>Page not found</p>`;
                }
            },

            // --- DASHBOARD (Unchanged logic, reads from local cache) ---
            getDashboardHTML() {
                const todaySales = this.getTodaySales();
                const stockValue = this.getCurrentStockValue();
                const bestSelling = this.getBestSellingItem();
                const lowStockItems = this.getLowStockItems();

                return `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-gray-600 text-sm font-medium">Today's Sales</h3>
                            <p class="text-3xl font-bold text-gray-800">₹${todaySales.toFixed(2)}</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-gray-600 text-sm font-medium">Current Stock Value</h3>
                            <p class="text-3xl font-bold text-gray-800">₹${stockValue.toFixed(2)}</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-gray-600 text-sm font-medium">Best-Selling Item (Month)</h3>
                            <p class="text-xl font-bold text-gray-800">${bestSelling}</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-gray-600 text-sm font-medium">Low Stock Alerts</h3>
                            <p class="text-3xl font-bold text-red-500">${lowStockItems.length}</p>
                        </div>
                    </div>
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Monthly Sales</h3>
                        <canvas id="salesChart"></canvas>
                    </div>
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Low Stock Items</h3>
                        ${lowStockItems.length > 0 ? `
                        <ul class="divide-y divide-gray-200">
                            ${lowStockItems.map(item => `
                                <li class="py-2">
                                    <span class="font-semibold">${item.productName} - ${item.variant.size} / ${item.variant.color}</span>: 
                                    <span class="text-red-500">${item.stock}</span> units left (Reorder at ${item.variant.reorderLevel})
                                </li>
                            `).join('')}
                        </ul>
                        ` : '<p>No items are currently low on stock.</p>'}
                    </div>
                `;
            },
            
            renderDashboardChart() {
                const ctx = document.getElementById('salesChart').getContext('2d');
                const salesData = this.getMonthlySalesForChart();
                this.chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: salesData.labels,
                        datasets: [{
                            label: 'Sales (₹)',
                            data: salesData.data,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            tension: 0.4
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true } } }
                });
            },

            getTodaySales() {
                const today = new Date().toISOString().slice(0, 10);
                return DB.transactions
                    .filter(t => t.type === 'Sale' && t.date.startsWith(today))
                    .reduce((total, t) => {
                        const variant = DB.getVariant(t.variantId);
                        return total + (Math.abs(t.quantity) * (variant ? variant.sellingPrice : 0));
                    }, 0);
            },

            getCurrentStockValue() {
                return DB.variants.reduce((total, v) => {
                    const stock = DB.getVariantStock(v.id);
                    return total + (stock * v.costPrice);
                }, 0);
            },

            getBestSellingItem() {
                const sales = DB.transactions.filter(t => t.type === 'Sale');
                if (sales.length === 0) return 'N/A';

                const salesByVariant = sales.reduce((acc, t) => {
                    acc[t.variantId] = (acc[t.variantId] || 0) + Math.abs(t.quantity);
                    return acc;
                }, {});

                if(Object.keys(salesByVariant).length === 0) return 'N/A';

                const bestVariantId = Object.keys(salesByVariant).reduce((a, b) => salesByVariant[a] > salesByVariant[b] ? a : b);
                const variant = DB.getVariant(bestVariantId);
                if (!variant) return 'N/A';
                const product = DB.getProduct(variant.productId);
                return product ? `${product.designName} (${variant.size}, ${variant.color})` : 'N/A';
            },

            getLowStockItems() {
                return DB.variants.map(v => {
                    const stock = DB.getVariantStock(v.id);
                    return { variant: v, stock };
                }).filter(item => item.stock <= item.variant.reorderLevel)
                .map(item => {
                    const product = DB.getProduct(item.variant.productId);
                    return { ...item, productName: product ? `${product.designName} (${item.variant.channel})` : 'Unknown Product' };
                });
            },

            getMonthlySalesForChart() {
                const sales = DB.transactions.filter(t => t.type === 'Sale');
                const data = {};
                const today = new Date();
                const pastDays = 30;

                for (let i = 0; i < pastDays; i++) {
                    const d = new Date(today);
                    d.setDate(d.getDate() - i);
                    const dateString = d.toISOString().slice(0, 10);
                    data[dateString] = 0;
                }

                sales.forEach(t => {
                    const dateString = t.date.slice(0, 10);
                    if (data[dateString] !== undefined) {
                        const variant = DB.getVariant(t.variantId);
                        data[dateString] += Math.abs(t.quantity) * (variant ? variant.sellingPrice : 0);
                    }
                });

                const sortedDates = Object.keys(data).sort();
                return {
                    labels: sortedDates.map(date => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                    data: sortedDates.map(date => data[date])
                };
            },

            // --- INVENTORY (Listeners now call async DB methods) ---
            getInventoryHTML() {
                return `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold">Products</h2>
                            <button id="add-product-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Add Product</button>
                        </div>
                        <div class="mb-4 border-b border-gray-200">
                            <nav class="flex -mb-px" id="inventory-tabs">
                                <a href="#" data-channel="Online" class="inventory-tab whitespace-nowrap py-4 px-3 border-b-2 font-medium text-sm border-blue-500 text-blue-600">Online</a>
                                <a href="#" data-channel="Offline" class="inventory-tab whitespace-nowrap py-4 px-3 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Offline</a>
                            </nav>
                        </div>
                        <div id="product-list">${this.renderProductList('Online')}</div>
                    </div>
                `;
            },

            renderProductList(channel) {
                const filteredProducts = DB.products.filter(p => p.channel && p.channel.includes(channel));
                if (filteredProducts.length === 0) {
                    return `<p class="mt-4 text-center text-gray-500">No ${channel.toLowerCase()} products found. Add one to get started!</p>`;
                }
                return filteredProducts.map(product => `
                    <div class="border rounded-lg p-4 mb-4" data-product-id="${product.id}">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold">${product.designName}</h3>
                                <p class="text-gray-600">${product.material} - <span class="${product.active ? 'text-green-500' : 'text-red-500'}">${product.active ? 'Active' : 'Inactive'}</span></p>
                            </div>
                            <div>
                                <button class="edit-product-btn text-blue-500 hover:text-blue-700 mr-2">Edit</button>
                                <button class="delete-product-btn text-red-500 hover:text-red-700">Delete</button>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold">Variants for ${channel} Channel</h4>
                                <button class="add-variant-btn bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">Add Variant</button>
                            </div>
                            <table class="w-full text-left">
                                <thead><tr class="bg-gray-100"><th class="p-2">SKU</th><th class="p-2">Size</th><th class="p-2">Color</th><th class="p-2">Stock</th><th class="p-2">Reorder At</th><th class="p-2">Selling Price</th><th class="p-2">Actions</th></tr></thead>
                                <tbody>${this.renderVariantListForProduct(product.id, channel)}</tbody>
                            </table>
                        </div>
                    </div>
                `).join('');
            },

            renderVariantListForProduct(productId, channel) {
                const variants = DB.variants.filter(v => v.productId === productId && v.channel === channel);
                if (variants.length === 0) return `<tr><td colspan="7" class="p-2 text-center">No variants for this product in this channel.</td></tr>`;
                
                return variants.map(v => {
                    const stock = DB.getVariantStock(v.id);
                    const isLowStock = stock <= v.reorderLevel;
                    return `
                    <tr class="border-b ${isLowStock ? 'bg-red-100 text-red-800' : ''}" data-variant-id="${v.id}">
                        <td class="p-2">${v.sku}</td><td class="p-2">${v.size}</td><td class="p-2">${v.color}</td>
                        <td class="p-2 font-bold">${stock}</td><td class="p-2">${v.reorderLevel}</td><td class="p-2">₹${v.sellingPrice.toFixed(2)}</td>
                        <td class="p-2">
                            <button class="adjust-stock-btn text-purple-500 hover:text-purple-700 mr-2 text-sm">Adjust</button>
                            <button class="edit-variant-btn text-blue-500 hover:text-blue-700 mr-2 text-sm">Edit</button>
                            <button class="delete-variant-btn text-red-500 hover:text-red-700 text-sm">Delete</button>
                        </td>
                    </tr>`;
                }).join('');
            },

            attachInventoryListeners() {
                // ... (Event listeners are the same, but the functions they call are now async)
                document.getElementById('add-product-btn').addEventListener('click', () => this.showProductModal());
                
                document.getElementById('inventory-tabs').addEventListener('click', (e) => {
                    e.preventDefault();
                    const target = e.target.closest('.inventory-tab');
                    if (target) {
                        document.querySelectorAll('.inventory-tab').forEach(tab => {
                            tab.classList.remove('border-blue-500', 'text-blue-600');
                            tab.classList.add('border-transparent', 'text-gray-500');
                        });
                        target.classList.add('border-blue-500', 'text-blue-600');
                        target.classList.remove('border-transparent', 'text-gray-500');
                        document.getElementById('product-list').innerHTML = this.renderProductList(target.dataset.channel);
                    }
                });

                document.getElementById('product-list').addEventListener('click', (e) => {
                    const target = e.target;
                    const productDiv = target.closest('[data-product-id]');
                    const variantRow = target.closest('[data-variant-id]');
                    
                    if (target.classList.contains('edit-product-btn')) this.showProductModal(DB.getProduct(productDiv.dataset.productId));
                    if (target.classList.contains('delete-product-btn')) {
                        if (confirm('Are you sure you want to delete this product and all its variants?')) DB.deleteProduct(productDiv.dataset.productId);
                    }
                    if (target.classList.contains('add-variant-btn')) {
                        const channel = document.querySelector('.inventory-tab.border-blue-500').dataset.channel;
                        this.showVariantModal(productDiv.dataset.productId, null, channel);
                    }
                    if (variantRow) {
                        const variantId = variantRow.dataset.variantId;
                        if (target.classList.contains('edit-variant-btn')) this.showVariantModal(DB.getVariant(variantId).productId, DB.getVariant(variantId));
                        if (target.classList.contains('delete-variant-btn')) {
                            if (confirm('Are you sure you want to delete this variant?')) DB.deleteVariant(variantId);
                        }
                        if (target.classList.contains('adjust-stock-btn')) this.showAdjustStockModal(variantId);
                    }
                });
            },
            
            showProductModal(product = null) {
                const modalContent = document.getElementById('modal-content');
                modalContent.innerHTML = `
                    <h3 class="text-2xl font-semibold mb-4">${product ? 'Edit' : 'Add'} Product</h3>
                    <form id="product-form">
                        <input type="hidden" name="id" value="${product ? product.id : ''}">
                        <div class="mb-4"><label class="block text-gray-700">Design Name</label><input type="text" name="designName" class="w-full px-3 py-2 border rounded" value="${product ? product.designName : ''}" required></div>
                        <div class="mb-4"><label class="block text-gray-700">Material</label><select name="material" class="w-full px-3 py-2 border rounded" required>${DB.settings.materials.map(m => `<option value="${m}" ${product && product.material === m ? 'selected' : ''}>${m}</option>`).join('')}</select></div>
                        <div class="mb-4"><label class="block text-gray-700">Sales Channel(s)</label><div class="flex space-x-4 mt-2"><label class="flex items-center"><input type="checkbox" name="channel" value="Online" class="mr-2 h-4 w-4" ${product && product.channel.includes('Online') ? 'checked' : ''}> Online</label><label class="flex items-center"><input type="checkbox" name="channel" value="Offline" class="mr-2 h-4 w-4" ${product && product.channel.includes('Offline') ? 'checked' : ''}> Offline</label></div></div>
                        <div class="mb-4"><label class="flex items-center"><input type="checkbox" name="active" class="mr-2" ${product ? (product.active ? 'checked' : '') : 'checked'}> Active</label></div>
                        <div class="flex justify-end"><button type="button" id="cancel-modal" class="bg-gray-300 text-gray-800 px-4 py-2 rounded mr-2">Cancel</button><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Save</button></div>
                    </form>`;
                this.showModal();

                document.getElementById('product-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const selectedChannels = Array.from(e.target.querySelectorAll('input[name="channel"]:checked')).map(cb => cb.value);
                    if (selectedChannels.length === 0) return alert('Please select at least one sales channel.');

                    const newProduct = {
                        id: formData.get('id'),
                        designName: formData.get('designName'), material: formData.get('material'),
                        channel: selectedChannels, active: formData.get('active') === 'on'
                    };
                    if (newProduct.id) DB.updateProduct(newProduct);
                    else DB.addProduct(newProduct);
                    this.hideModal();
                });
            },

            showVariantModal(productId, variant = null, channelForNew = null) {
                // This function's logic remains largely the same, but the final DB calls are async
                // ... (HTML generation is identical)
                const modalContent = document.getElementById('modal-content');
                let formHTML = '';

                if (variant) { // Editing
                    formHTML = `<h3 class="text-2xl font-semibold mb-4">Edit Variant</h3><form id="variant-form"><input type="hidden" name="id" value="${variant.id}"><input type="hidden" name="productId" value="${productId}"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="mb-4"><label class="block text-gray-700">SKU</label><input type="text" name="sku" class="w-full px-3 py-2 border rounded" value="${variant.sku}" required></div><div class="mb-4"><label class="block text-gray-700">Size</label><select name="size" class="w-full px-3 py-2 border rounded" required>${DB.settings.sizes.map(s => `<option value="${s}" ${variant.size === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div><div class="mb-4"><label class="block text-gray-700">Color</label><select name="color" class="w-full px-3 py-2 border rounded" required>${DB.settings.colors.map(c => `<option value="${c}" ${variant.color === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div><div class="mb-4"><label class="block text-gray-700">Cost Price</label><input type="number" step="0.01" name="costPrice" class="w-full px-3 py-2 border rounded" value="${variant.costPrice}" required></div><div class="mb-4"><label class="block text-gray-700">Selling Price</label><input type="number" step="0.01" name="sellingPrice" class="w-full px-3 py-2 border rounded" value="${variant.sellingPrice}" required></div><div class="mb-4"><label class="block text-gray-700">Reorder Level</label><input type="number" name="reorderLevel" class="w-full px-3 py-2 border rounded" value="${variant.reorderLevel}" required></div></div>`;
                } else { // Adding new
                    formHTML = `<h3 class="text-2xl font-semibold mb-4">Add Variants for ${channelForNew} Channel</h3><p class="text-sm text-gray-600 mb-4">Select multiple sizes and colors to create all combinations at once.</p><form id="variant-form" data-bulk="true" data-channel-for-new="${channelForNew}"><input type="hidden" name="productId" value="${productId}"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="block text-gray-700 font-semibold mb-2">Sizes</label><div class="space-y-2">${DB.settings.sizes.map(s => `<label class="flex items-center"><input type="checkbox" name="sizes" value="${s}" class="mr-2 h-4 w-4">${s}</label>`).join('')}</div></div><div><label class="block text-gray-700 font-semibold mb-2">Colors</label><div class="space-y-2">${DB.settings.colors.map(c => `<label class="flex items-center"><input type="checkbox" name="colors" value="${c}" class="mr-2 h-4 w-4">${c}</label>`).join('')}</div></div></div><hr class="my-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="mb-4"><label class="block text-gray-700">Base SKU</label><input type="text" name="baseSku" class="w-full px-3 py-2 border rounded" placeholder="e.g., TSHIRT-SUMMER" required><p class="text-xs text-gray-500 mt-1">Final SKU will be: BaseSKU-Size-Color</p></div><div class="mb-4"><label class="block text-gray-700">Initial Stock (for each variant)</label><input type="number" name="initialStock" class="w-full px-3 py-2 border rounded" value="0" required></div><div class="mb-4"><label class="block text-gray-700">Cost Price</label><input type="number" step="0.01" name="costPrice" class="w-full px-3 py-2 border rounded" required></div><div class="mb-4"><label class="block text-gray-700">Selling Price</label><input type="number" step="0.01" name="sellingPrice" class="w-full px-3 py-2 border rounded" required></div><div class="mb-4 md:col-span-2"><label class="block text-gray-700">Reorder Level</label><input type="number" name="reorderLevel" class="w-full px-3 py-2 border rounded" value="10" required></div></div>`;
                }

                modalContent.innerHTML = formHTML + `<div class="flex justify-end mt-4"><button type="button" id="cancel-modal" class="bg-gray-300 text-gray-800 px-4 py-2 rounded mr-2">Cancel</button><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Save</button></div></form>`;
                this.showModal();

                document.getElementById('variant-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const formData = new FormData(form);
                    
                    if (form.dataset.bulk) {
                        const channel = form.dataset.channelForNew;
                        const selectedSizes = Array.from(form.querySelectorAll('input[name="sizes"]:checked')).map(cb => cb.value);
                        const selectedColors = Array.from(form.querySelectorAll('input[name="colors"]:checked')).map(cb => cb.value);
                        if (selectedSizes.length === 0 || selectedColors.length === 0) return alert('Please select at least one size and one color.');

                        selectedSizes.forEach(size => {
                            selectedColors.forEach(color => {
                                DB.addVariant({
                                    productId: formData.get('productId'),
                                    sku: `${formData.get('baseSku')}-${size}-${color.toUpperCase()}`,
                                    size, color, channel,
                                    costPrice: parseFloat(formData.get('costPrice')),
                                    sellingPrice: parseFloat(formData.get('sellingPrice')),
                                    reorderLevel: parseInt(formData.get('reorderLevel'), 10),
                                    initialStock: parseInt(formData.get('initialStock') || '0', 10)
                                });
                            });
                        });
                    } else {
                        DB.updateVariant({
                            id: formData.get('id'), productId: formData.get('productId'),
                            sku: formData.get('sku'), size: formData.get('size'), color: formData.get('color'),
                            costPrice: parseFloat(formData.get('costPrice')),
                            sellingPrice: parseFloat(formData.get('sellingPrice')),
                            reorderLevel: parseInt(formData.get('reorderLevel'), 10),
                            channel: DB.getVariant(formData.get('id')).channel
                        });
                    }
                    this.hideModal();
                });
            },

            showAdjustStockModal(variantId) {
                // ... (Unchanged logic, calls async DB method)
                 const variant = DB.getVariant(variantId);
                const product = DB.getProduct(variant.productId);
                const currentStock = DB.getVariantStock(variant.id);

                const modalContent = document.getElementById('modal-content');
                modalContent.innerHTML = `
                    <h3 class="text-2xl font-semibold mb-4">Adjust Stock</h3>
                    <p class="mb-4"><strong>${product.designName} - ${variant.size} / ${variant.color} (${variant.channel})</strong></p>
                    <p class="mb-4">Current Stock: <strong>${currentStock}</strong></p>
                    <form id="adjust-stock-form">
                        <input type="hidden" name="variantId" value="${variantId}">
                        <div class="mb-4"><label class="block text-gray-700">Transaction Type</label><select name="type" class="w-full px-3 py-2 border rounded" required><option value="Purchase">Purchase</option><option value="Adjustment">Adjustment</option><option value="Return">Return</option></select></div>
                        <div class="mb-4"><label class="block text-gray-700">Quantity</label><input type="number" name="quantity" class="w-full px-3 py-2 border rounded" required><p class="text-sm text-gray-500">Positive to add, negative to remove.</p></div>
                        <div class="mb-4"><label class="block text-gray-700">Notes (Optional)</label><textarea name="notes" class="w-full px-3 py-2 border rounded"></textarea></div>
                        <div class="flex justify-end"><button type="button" id="cancel-modal" class="bg-gray-300 text-gray-800 px-4 py-2 rounded mr-2">Cancel</button><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Save</button></div>
                    </form>`;
                this.showModal();

                document.getElementById('adjust-stock-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    DB.addTransaction({
                        variantId: formData.get('variantId'),
                        type: formData.get('type'),
                        quantity: parseInt(formData.get('quantity'), 10),
                        salesChannel: 'N/A',
                        notes: formData.get('notes')
                    });
                    this.hideModal();
                });
            },

            // --- SALES (Unchanged logic, calls async DB method) ---
            getSalesHTML() {
                const variantsOptions = DB.variants
                    .filter(v => DB.getProduct(v.productId)?.active)
                    .map(v => {
                        const p = DB.getProduct(v.productId);
                        return `<option value="${v.id}">${p.designName} (${v.channel}) - ${v.size} / ${v.color}</option>`
                    }).join('');
                return `
                    <div class="bg-white p-6 rounded-lg shadow-md max-w-lg mx-auto">
                        <h2 class="text-2xl font-semibold mb-4">Record a Sale</h2>
                        <form id="sales-form">
                            <div class="mb-4"><label class="block text-gray-700">Product Variant</label><select name="variantId" class="w-full px-3 py-2 border rounded" required><option value="">Select a variant</option>${variantsOptions}</select></div>
                            <div class="mb-4"><label class="block text-gray-700">Quantity</label><input type="number" name="quantity" class="w-full px-3 py-2 border rounded" required min="1"></div>
                            <div class="mb-4"><label class="block text-gray-700">Sales Channel</label><select name="salesChannel" class="w-full px-3 py-2 border rounded" required><option value="Online">Online</option><option value="Offline">Offline</option></select></div>
                            <div class="mb-4"><label class="block text-gray-700">Notes (Optional)</label><textarea name="notes" class="w-full px-3 py-2 border rounded"></textarea></div>
                            <button type="submit" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Record Sale</button>
                        </form>
                        <div id="sale-feedback" class="mt-4"></div>
                    </div>`;
            },
            
            attachSalesListeners() {
                document.getElementById('sales-form').addEventListener('submit', e => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const variantId = formData.get('variantId');
                    const quantity = parseInt(formData.get('quantity'), 10);
                    const currentStock = DB.getVariantStock(variantId);
                    const feedbackDiv = document.getElementById('sale-feedback');

                    if (quantity > currentStock) {
                        feedbackDiv.innerHTML = `<p class="text-red-500">Error: Not enough stock. Only ${currentStock} units available.</p>`;
                        return;
                    }
                    DB.addTransaction({
                        variantId: variantId, type: 'Sale', quantity: -quantity,
                        salesChannel: formData.get('salesChannel'), notes: formData.get('notes')
                    });
                    feedbackDiv.innerHTML = `<p class="text-green-500">Sale recorded successfully!</p>`;
                    e.target.reset();
                    setTimeout(() => feedbackDiv.innerHTML = '', 3000);
                });
            },

            // --- REPORTS (Unchanged logic) ---
            getReportsHTML() {
                return `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Generate Reports</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="border p-4 rounded"><h3 class="font-semibold">Stock Report</h3><p class="text-sm text-gray-600 mb-2">Current stock levels for all variants.</p><button data-report="stock" class="generate-report-btn bg-blue-500 text-white px-4 py-2 rounded text-sm">Generate</button></div>
                            <div class="border p-4 rounded"><h3 class="font-semibold">Sales Report (Monthly)</h3><p class="text-sm text-gray-600 mb-2">Summary of sales for the current month.</p><button data-report="sales" class="generate-report-btn bg-blue-500 text-white px-4 py-2 rounded text-sm">Generate</button></div>
                            <div class="border p-4 rounded"><h3 class="font-semibold">Purchase Report</h3><p class="text-sm text-gray-600 mb-2">Details of all stock purchases.</p><button data-report="purchase" class="generate-report-btn bg-blue-500 text-white px-4 py-2 rounded text-sm">Generate</button></div>
                            <div class="border p-4 rounded"><h3 class="font-semibold">Transaction Log</h3><p class="text-sm text-gray-600 mb-2">Complete history of all stock movements.</p><button data-report="transactions" class="generate-report-btn bg-blue-500 text-white px-4 py-2 rounded text-sm">Generate</button></div>
                        </div>
                        <div id="report-output" class="mt-6"></div>
                    </div>`;
            },
            
            attachReportsListeners() {
                document.querySelectorAll('.generate-report-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.generateReport(btn.dataset.report));
                });
            },

            generateReport(type) {
                // ... (Unchanged logic)
                const output = document.getElementById('report-output');
                let data, headers, title;
                switch (type) {
                    case 'stock':
                        title = 'Stock Report';
                        headers = ['Product', 'Channel', 'SKU', 'Size', 'Color', 'Stock', 'Reorder Level', 'Status'];
                        data = DB.variants.map(v => {
                            const p = DB.getProduct(v.productId);
                            const stock = DB.getVariantStock(v.id);
                            return [p.designName, v.channel, v.sku, v.size, v.color, stock, v.reorderLevel, stock <= v.reorderLevel ? 'Low Stock' : 'OK'];
                        });
                        break;
                    case 'sales':
                        title = 'Monthly Sales Report';
                        headers = ['Date', 'Product', 'SKU', 'Quantity', 'Channel', 'Total (₹)'];
                        const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                        data = DB.transactions.filter(t => t.type === 'Sale' && new Date(t.date) >= firstDay).map(t => {
                            const v = DB.getVariant(t.variantId);
                            const p = DB.getProduct(v.productId);
                            const quantity = Math.abs(t.quantity);
                            return [new Date(t.date).toLocaleDateString(), p.designName, v.sku, quantity, t.salesChannel, (quantity * v.sellingPrice).toFixed(2)];
                        });
                        break;
                    // ... other cases are the same
                }
                this.renderReportTable(output, title, headers, data);
            },

            renderReportTable(container, title, headers, data) {
                container.innerHTML = `
                    <h3 class="text-xl font-semibold mb-2">${title}</h3>
                    <div class="flex gap-2 mb-4"><button id="export-excel" class="bg-gray-700 text-white px-3 py-1 rounded text-sm">Export Excel</button></div>
                    <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="bg-gray-100">${headers.map(h => `<th class="p-2 border">${h}</th>`).join('')}</tr></thead><tbody>${data.length > 0 ? data.map(row => `<tr class="border-b">${row.map(cell => `<td class="p-2 border">${cell}</td>`).join('')}</tr>`).join('') : `<tr><td colspan="${headers.length}" class="p-2 border text-center">No data.</td></tr>`}</tbody></table></div>`;
                document.getElementById('export-excel').addEventListener('click', () => this.exportToSheet(headers, data, `${title}.xlsx`));
            },

            exportToSheet(headers, data, fileName) {
                const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Report');
                XLSX.writeFile(wb, fileName);
            },

            // --- SETTINGS (Now saves to Firestore) ---
            getSettingsHTML() {
                // Backup/Restore is removed as data is now live in the cloud.
                return `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-semibold mb-4">Manage Categories</h2>
                            ${this.renderCategoryManagement('sizes', 'Sizes')}
                            ${this.renderCategoryManagement('colors', 'Colors')}
                            ${this.renderCategoryManagement('materials', 'Materials')}
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                             <h2 class="text-2xl font-semibold mb-4">Cloud Data</h2>
                             <p class="text-gray-600">Your data is now saved automatically to the cloud. You can sign in from any device using your User ID to access the same inventory.</p>
                             <p class="mt-4 text-sm text-gray-500">Note: The Backup/Restore feature has been removed as it's not needed with a live cloud database.</p>
                        </div>
                    </div>`;
            },

            renderCategoryManagement(key, title) {
                return `
                    <div class="mb-4">
                        <h3 class="font-semibold">${title}</h3>
                        <div class="flex flex-wrap gap-2 my-2">
                            ${(DB.settings[key] || []).map(item => `
                                <span class="bg-gray-200 px-2 py-1 rounded-full text-sm flex items-center">
                                    ${item}
                                    <button data-key="${key}" data-value="${item}" class="remove-category-item ml-2 text-red-500">&times;</button>
                                </span>`).join('')}
                        </div>
                        <form class="flex gap-2" data-key="${key}">
                            <input type="text" placeholder="Add new ${title.slice(0, -1)}" class="flex-grow px-3 py-1 border rounded">
                            <button type="submit" class="bg-green-500 text-white px-3 py-1 rounded">Add</button>
                        </form>
                    </div>`;
            },

            attachSettingsListeners() {
                document.querySelectorAll('.remove-category-item').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const key = e.target.dataset.key;
                        const value = e.target.dataset.value;
                        const newSettings = { ...DB.settings };
                        newSettings[key] = newSettings[key].filter(item => item !== value);
                        DB.saveSettings(newSettings);
                    });
                });

                document.querySelectorAll('form[data-key]').forEach(form => {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const key = e.target.dataset.key;
                        const input = e.target.querySelector('input');
                        const value = input.value.trim();
                        if (value && !(DB.settings[key] || []).includes(value)) {
                            const newSettings = { ...DB.settings };
                            if (!newSettings[key]) newSettings[key] = [];
                            newSettings[key].push(value);
                            DB.saveSettings(newSettings);
                        }
                        input.value = '';
                    });
                });
            },

            // --- MODAL ---
            showModal() {
                document.getElementById('modal').classList.remove('hidden');
                document.getElementById('cancel-modal').addEventListener('click', this.hideModal);
            },
            hideModal() {
                document.getElementById('modal').classList.add('hidden');
            }
        };
    </script>
</body>
</html>
